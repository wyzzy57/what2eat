from typing import List, Optional
from sqlmodel import select, col, desc, asc
from sqlmodel.ext.asyncio.session import AsyncSession
from sqlalchemy.exc import IntegrityError

from src.dishes.model import Dish
from schema import DishCreate, DishUpdate


class DishRepository:
    """
    æ•°æ®åº“ä»“å‚¨å±‚ (Repository Pattern)
    è´Ÿè´£æ‰€æœ‰çš„æ•°æ®åº“ CRUD æ“ä½œï¼Œä¸åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘
    """

    def __init__(self, session: AsyncSession):
        self.session = session

    # ðŸŸ¢ dish_in åªæ˜¯ç”¨æˆ·ä¼ æ¥çš„ JSON æ•°æ®ï¼ˆæ¯”å¦‚ {"name": "ç‚’è›‹"}ï¼‰ã€‚
    #è¿™å°±å¥½æ¯”ä¸€å¼ â€œè¿›è´§å•â€ã€‚è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ ¹æ®è¿›è´§å•ï¼Œç”Ÿæˆä¸€ä¸ªçœŸå®žçš„æ•°æ®åº“å¯¹è±¡ Dishï¼ˆåŒ…å« ID å ä½ç¬¦ã€è¡¨ç»“æž„ç­‰ï¼‰ã€‚
    # è¿™æ—¶å€™æ•°æ®åº“è¿˜æ²¡æœ‰çœŸæ­£å­˜å‚¨è¿™ä¸ªå¯¹è±¡ï¼Œåªæ˜¯åœ¨å†…å­˜é‡Œç­‰å¾…ç¡®è®¤ã€‚
    # åªæœ‰å½“ä½ è°ƒç”¨ commit æ—¶ï¼Œæ•°æ®åº“æ‰ä¼šçœŸæ­£å­˜å‚¨è¿™ä¸ªå¯¹è±¡ã€‚
    async def create(self, dish_in: DishCreate) -> Dish:
        # ä½¿ç”¨ SQLModel çš„ model_validate å°† Schema è½¬ä¸º DB Model
        #æŠŠâ€œè¿›è´§å•â€å˜æˆâ€œå®žç‰©â€
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ ¹æ®è¿›è´§å•ï¼Œç”Ÿæˆä¸€ä¸ªçœŸå®žçš„æ•°æ®åº“å¯¹è±¡ Dishï¼ˆåŒ…å« ID å ä½ç¬¦ã€è¡¨ç»“æž„ç­‰ï¼‰ã€‚
        #model_validate æ˜¯ SQLModel æä¾›çš„æ–¹æ³•ï¼Œä½œç”¨æ˜¯æŠŠ Schema è½¬æ¢ä¸º DB Modelã€‚
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„ JSON æ•°æ®ï¼ˆdish_inï¼‰ï¼Œç”Ÿæˆä¸€ä¸ª Dish æ•°æ®åº“å¯¹è±¡ï¼ˆdishï¼‰ã€‚
        # è¿™ä¸ªè¿‡ç¨‹å«åšâ€œæ¨¡åž‹éªŒè¯â€ï¼ˆmodel validationï¼‰ã€‚
        # æ¨¡åž‹éªŒè¯çš„ä½œç”¨æ˜¯ç¡®ä¿ç”¨æˆ·ä¼ å…¥çš„æ•°æ®ç¬¦åˆæ•°æ®åº“è¡¨çš„å®šä¹‰ã€‚
        # æ¯”å¦‚å¦‚æžœç”¨æˆ·ä¼ å…¥çš„ JSON æ•°æ®é‡Œæ²¡æœ‰ name å­—æ®µï¼Œæˆ–è€… name å­—æ®µä¸æ˜¯å­—ç¬¦ä¸²ï¼Œ
        # å°±ä¼šè§¦å‘éªŒè¯é”™è¯¯ï¼Œé˜»æ­¢æ•°æ®å…¥åº“ã€‚
        #model_validate
        dish = Dish.model_validate(dish_in)
        #æŠŠè´§æ”¾åˆ°ä¼ é€å¸¦ä¸Šï¼ˆè¿˜æ²¡å…¥åº“ï¼‰
        #æ­¤æ—¶ dish è¿˜åœ¨ Python çš„å†…å­˜é‡Œã€‚è¿™å¥è¯æ˜¯å‘Šè¯‰æ•°æ®åº“ï¼šâ€œå˜¿ï¼Œæˆ‘å‡†å¤‡å­˜ä¸ªä¸œè¥¿ï¼Œä½ å‡†å¤‡ä¸€ä¸‹ã€‚â€ï¼ˆæ­¤æ—¶è¿˜æ²¡çœŸæ­£å†™å…¥ç¡¬ç›˜ï¼‰ã€‚
        self.session.add(dish)
        try:
            #æŒ‰ä¸‹ç¡®è®¤é”®ï¼Œæ­£å¼å…¥åº“
            await self.session.commit()
        except IntegrityError:
            #å¦‚æžœæŠ¥è­¦äº†ï¼ˆæ¯”å¦‚åå­—é‡å¤ï¼‰ï¼Œèµ¶ç´§æ’¤é”€ï¼Œåˆ«å¡æ­»
            #rollback å°±æ˜¯æ’¤é”€ä¹‹å‰çš„æ“ä½œï¼Œå°±åƒä½ åœ¨è‰ç¨¿çº¸ä¸Šå†™äº†ç‚¹ä¸œè¥¿ï¼Œç»“æžœå‘çŽ°ä¸å¯¹ï¼Œå°±æ“¦æŽ‰é‡å†™ã€‚
            await self.session.rollback()
            raise
        #é‡æ–°çœ‹ä¸€çœ¼å…¥åº“åŽçš„è´§ï¼ˆä¸ºäº†æ‹¿åˆ°è‡ªåŠ¨ç”Ÿæˆçš„ ID å’Œ åˆ›å»ºæ—¶é—´ï¼‰
        #commit ä¹‹åŽï¼Œæ•°æ®åº“ç”Ÿæˆäº† ID å’Œæ—¶é—´ï¼Œä½† Python å†…å­˜é‡Œçš„è¿™ä¸ªå¯¹è±¡è¿˜ä¸çŸ¥é“ã€‚
        # refresh å°±æ˜¯è®© Python è·‘åŽ»æ•°æ®åº“é—®ï¼šâ€œåˆšæ‰å­˜çš„é‚£æ¡æ•°æ®ï¼ŒID æ˜¯å¤šå°‘ï¼Ÿæ—¶é—´æ˜¯å¤šå°‘ï¼Ÿå¿«åŒæ­¥ç»™æˆ‘ã€‚â€
        # ç„¶åŽ Python å†…å­˜é‡Œçš„å¯¹è±¡å°±ä¼šæ›´æ–°ã€‚
        await self.session.refresh(dish)
        return dish
    # ðŸ” æŸ¥è¯¢å•ä¸ªèœå“ï¼ˆæ ¹æ® IDï¼‰
    # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¸­ ID ä¸º dish_id çš„è®°å½•ã€‚
    # å¦‚æžœæ‰¾åˆ°ï¼Œå°±è¿”å›žä¸€ä¸ª Dish å¯¹è±¡ï¼›å¦‚æžœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±è¿”å›ž Noneã€‚
    async def get_by_id(self, dish_id: int) -> Optional[Dish]:
        #Dish æ˜¯ä¸€ä¸ª Python ç±» (Class)ï¼Œå®ƒä»£è¡¨äº†æ•°æ®åº“é‡Œçš„ dishes è¡¨ã€‚
        # å®ƒæ˜¯ä»Žä½ ä¹‹å‰å†™å¥½çš„ model.py æ–‡ä»¶é‡Œå¯¼å…¥è¿›æ¥çš„ã€‚
        #Dish æ˜¯æ•°æ®åº“è¡¨åï¼Œdish_id æ˜¯ç”¨æˆ·ä¼ å…¥çš„å‚æ•°ã€‚
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¸­ ID ä¸º dish_id çš„è®°å½•ã€‚
        # å¦‚æžœæ‰¾åˆ°ï¼Œå°±è¿”å›žä¸€ä¸ª Dish å¯¹è±¡ï¼›å¦‚æžœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±è¿”å›ž Noneã€‚
        #Dishæ˜¯ä»Žæ•°æ®åº“è¡¨ä¸­æŸ¥è¯¢å‡ºæ¥çš„ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª Dish å¯¹è±¡ã€‚
        #æ€Žä¹ˆè°ƒç”¨ï¼š
        # å‡è®¾ä½ æœ‰ä¸€ä¸ª dish_id = 123ï¼Œä½ å¯ä»¥è¿™æ ·è°ƒç”¨ï¼š
        # dish = await dish_repo.get_by_id(123)
        # å¦‚æžœæ•°æ®åº“ä¸­ ID ä¸º 123 çš„è®°å½•å­˜åœ¨ï¼Œdish å°±ä¼šæ˜¯ä¸€ä¸ª Dish å¯¹è±¡ï¼›å¦‚æžœä¸å­˜åœ¨ï¼Œdish å°±ä¼šæ˜¯ Noneã€‚
       
        return await self.session.get(Dish, dish_id)

    # ðŸŸ¡ å˜åŒ– 2: æŸ¥è¯¢é€»è¾‘å¾®è°ƒ (select æ¥è‡ª sqlmodel)
    async def get_all(
            self,
            *,
            search: Optional[str] = None,
            order_by: str = "id",
            direction: str = "asc",
            limit: int = 10,
            offset: int = 0,
    ) -> List[Dish]:

        # SQLModel çš„ select å†™æ³•æ›´åƒ Python ç±»åž‹æ³¨è§£
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¸­æ‰€æœ‰çš„ Dish è®°å½•ã€‚
        # å®ƒå°±å¥½æ¯”ä½ åœ¨æ•°æ®åº“é‡Œå†™äº† SQL è¯­å¥ï¼šSELECT * FROM dishesï¼Œè¿˜æ²¡æŸ¥è¯¢ï¼ŒåŽç»­è¦å†™ç­›é€‰è¯­å¥
        # ä½†æ˜¯å› ä¸ºä½¿ç”¨äº† SQLModelï¼Œæ‰€ä»¥ä½ å¯ä»¥ç›´æŽ¥å†™ Python ä»£ç ï¼Œè€Œä¸éœ€è¦å†™ SQL è¯­å¥ã€‚
        statement = select(Dish)

        # 1. æœç´¢
        if search:
            # col() å¸®åŠ©ç¼–è¾‘å™¨è¯†åˆ«å­—æ®µï¼Œilike æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„æ¨¡ç³ŠåŒ¹é…
            # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¸­ name æˆ– description åŒ…å« search å­—ç¬¦ä¸²çš„è®°å½•ã€‚
            # æ¯”å¦‚å¦‚æžœ search æ˜¯ "è›‹"ï¼Œå°±ä¼šæŸ¥è¯¢æ‰€æœ‰åç§°æˆ–æè¿°ä¸­åŒ…å« "è›‹" çš„èœå“ã€‚
            statement = statement.where(
                col(Dish.name).ilike(f"%{search}%") |
                col(Dish.description).ilike(f"%{search}%")
            )

        # 2. æŽ’åº
        # å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢ SQL æ³¨å…¥æˆ–æŠ¥é”™ï¼Œåªå…è®¸ç‰¹å®šå­—æ®µæŽ’åº
        valid_sort_fields = {"id", "name", "created_at"}
        if order_by not in valid_sort_fields:
            order_by = "id"

        # getattr åŠ¨æ€èŽ·å–å­—æ®µå¯¹è±¡ (Dish.id, Dish.name ...)
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ ¹æ® order_by å­—ç¬¦ä¸²ï¼ŒåŠ¨æ€èŽ·å– Dish ç±»é‡Œå¯¹åº”çš„å­—æ®µå¯¹è±¡ã€‚
        # æ¯”å¦‚å¦‚æžœ order_by æ˜¯ "name"ï¼Œå°±ä¼šèŽ·å– Dish.name è¿™ä¸ªå­—æ®µå¯¹è±¡ã€‚ 
        #getattr å°±æ˜¯ Python çš„é­”æ³•å‡½æ•°ï¼Œå®ƒå¯ä»¥æŠŠå­—ç¬¦ä¸²å˜æˆå±žæ€§å¯¹è±¡
        sort_column = getattr(Dish, order_by)

        if direction == "desc":
            # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ ¹æ® sort_column å­—æ®µï¼Œå¯¹æŸ¥è¯¢ç»“æžœè¿›è¡Œé™åºæŽ’åºã€‚
            # æ¯”å¦‚å¦‚æžœ sort_column æ˜¯ Dish.nameï¼Œå°±ä¼šæŒ‰åç§°å€’åºæŽ’åºã€‚
            # ä¸ºä»€ä¹ˆè¦ç”¨å­—æ®µå¯¹è±¡æŽ’åºï¼Œè€Œä¸æ˜¯ç›´æŽ¥ç”¨å­—ç¬¦ä¸²ï¼Ÿ
            # å› ä¸ºå­—æ®µå¯¹è±¡å¯ä»¥ç›´æŽ¥è¢« SQLAlchemy è¯†åˆ«å’Œå¤„ç†ï¼Œè€Œå­—ç¬¦ä¸²åˆ™éœ€è¦æ‰‹åŠ¨è½¬ä¹‰ï¼Œå¢žåŠ äº†é£Žé™©ã€‚
            statement = statement.order_by(desc(sort_column))
        else:
            # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ ¹æ® sort_column å­—æ®µï¼Œå¯¹æŸ¥è¯¢ç»“æžœè¿›è¡Œå‡åºæŽ’åºã€‚
            # æ¯”å¦‚å¦‚æžœ sort_column æ˜¯ Dish.nameï¼Œå°±ä¼šæŒ‰åç§°å‡åºæŽ’åºã€‚
            statement = statement.order_by(asc(sort_column))

        # 3. åˆ†é¡µ
        statement = statement.offset(offset).limit(limit)

        # æ‰§è¡ŒæŸ¥è¯¢
        result = await self.session.exec(statement)
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œè¿”å›žä¸€ä¸ªç»“æžœé›†ï¼ˆResult ç±»åž‹ï¼‰ã€‚
        # ç»“æžœé›†æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œä½ å¯ä»¥ç”¨ for å¾ªçŽ¯éåŽ†å®ƒï¼Œæˆ–è€…ç”¨ all() æ–¹æ³•æŠŠå®ƒå˜æˆä¸€ä¸ªåˆ—è¡¨ã€‚
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŠŠç»“æžœé›†è½¬æ¢ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œæ–¹ä¾¿åŽç»­å¤„ç†ã€‚
        return list(result.all())

    # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ›´æ–°æ•°æ®åº“ä¸­ ID ä¸º dish_id çš„è®°å½•ã€‚
    # å¦‚æžœæ‰¾åˆ°ï¼Œå°±è¿”å›žä¸€ä¸ª Dish å¯¹è±¡ï¼›å¦‚æžœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±è¿”å›ž Noneã€‚
    async def update(self, dish_id: int, dish_in: DishUpdate) -> Optional[Dish]:
        # å…ˆæŸ¥æ—§æ•°æ®
        dish = await self.session.get(Dish, dish_id)
        if not dish:
            return None

        # æ ¸å¿ƒé­”æ³•ï¼šexclude_unset=True
        # å¦‚æžœ dish_in é‡Œæ²¡æœ‰ä¼  nameï¼Œå°±ä¸æ›´æ–° nameï¼Œåªæ›´æ–°ä¼ äº†çš„å­—æ®µ
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŠŠ dish_in è¿™ä¸ª Pydantic æ¨¡åž‹å¯¹è±¡ï¼Œè½¬æ¢ä¸ºä¸€ä¸ªå­—å…¸ã€‚
        # å­—å…¸çš„é”®æ˜¯å­—æ®µåï¼Œå€¼æ˜¯å­—æ®µå€¼ã€‚
        # è¿™ä¸ªæ“ä½œçš„ä½œç”¨æ˜¯æŠŠç”¨æˆ·ä¼ å…¥çš„æ›´æ–°æ•°æ®ï¼Œå˜æˆä¸€ä¸ªå¯ä»¥ç›´æŽ¥ç”¨æ¥æ›´æ–°æ•°æ®åº“çš„å­—å…¸ã€‚
        update_data = dish_in.model_dump(exclude_unset=True)

        # è‡ªåŠ¨æŠŠå­—å…¸æ•°æ®â€œæ¶‚æŠ¹â€åˆ°å¯¹è±¡ä¸Š
        dish.sqlmodel_update(update_data)
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŠŠ update_data è¿™ä¸ªå­—å…¸ï¼Œâ€œæ¶‚æŠ¹â€åˆ° dish è¿™ä¸ªå¯¹è±¡ä¸Šã€‚
        # å­—å…¸çš„é”®æ˜¯å­—æ®µåï¼Œå€¼æ˜¯å­—æ®µå€¼ã€‚
        # è¿™ä¸ªæ“ä½œçš„ä½œç”¨æ˜¯æŠŠç”¨æˆ·ä¼ å…¥çš„æ›´æ–°æ•°æ®ï¼Œæ›´æ–°åˆ° dish å¯¹è±¡ä¸Šã€‚
        # æ¯”å¦‚å¦‚æžœ update_data æ˜¯ {"name": "æ–°åç§°"}ï¼Œå°±ä¼šæŠŠ dish.name æ›´æ–°ä¸º "æ–°åç§°"ã€‚
        # ä¸ºä»€ä¹ˆåŽé¢ä¸¤æ­¥è¦ç”¨å¼‚æ­¥ï¼Ÿ
        # å› ä¸ºæ•°æ®åº“æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œä¸ºäº†é¿å…é˜»å¡žäº‹ä»¶å¾ªçŽ¯ï¼Œæˆ‘ä»¬éœ€è¦ç”¨å¼‚æ­¥æ“ä½œã€‚
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æŠŠ dish å¯¹è±¡æ·»åŠ åˆ°æ•°æ®åº“ä¼šè¯ä¸­ã€‚
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æäº¤æ•°æ®åº“ä¼šè¯ï¼ŒæŠŠæ‰€æœ‰å˜æ›´ä¿å­˜åˆ°æ•°æ®åº“ã€‚
        # è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯åˆ·æ–°æ•°æ®åº“ä¼šè¯ï¼Œç¡®ä¿ dish å¯¹è±¡æ˜¯æœ€æ–°çš„ã€‚
        # ä¸ºä»€ä¹ˆ add ä¸æ˜¯å¼‚æ­¥çš„ï¼Ÿ
        # å› ä¸º add æ“ä½œåªæ˜¯æŠŠå¯¹è±¡æ·»åŠ åˆ°ä¼šè¯ä¸­ï¼Œå¹¶æ²¡æœ‰ç«‹å³æ‰§è¡Œæ•°æ®åº“æ“ä½œã€‚
        # åªæœ‰ commit æ“ä½œæ‰ä¼šè§¦å‘æ•°æ®åº“æ“ä½œï¼Œæ‰€ä»¥ add ä¸éœ€è¦å¼‚æ­¥ã€‚
        self.session.add(dish)
        await self.session.commit()
        await self.session.refresh(dish)
        return dish
    
    async def delete(self, dish_id: int) -> bool:
        dish = await self.session.get(Dish, dish_id)
        if not dish:
            return False

        await self.session.delete(dish)
        await self.session.commit()
        return True